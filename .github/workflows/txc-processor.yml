name: TXC Schedule Processor

on:
  repository_dispatch:
    types: [monthly-update, daily-update]
  workflow_dispatch: # Manual trigger for testing

jobs:
  process-txc:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # 3 hours max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Cache pip dependencies
      
      - name: Create requirements file
        run: |
          echo "psycopg2-binary" > /tmp/requirements.txt
          echo "requests" >> /tmp/requirements.txt
          echo "lxml" >> /tmp/requirements.txt
          echo "python-dotenv" >> /tmp/requirements.txt
      
      - name: Install dependencies
        run: |
          pip install -r /tmp/requirements.txt
      
      - name: Determine update type
        id: update-type
        run: |
          if [[ "${{ github.event.action }}" == "monthly-update" ]]; then
            echo "type=monthly" >> $GITHUB_OUTPUT
            echo "üì¶ Processing MONTHLY update"
          else
            echo "type=daily" >> $GITHUB_OUTPUT
            echo "üì¶ Processing DAILY update"
          fi
      
      - name: Process Monthly Update
        if: steps.update-type.outputs.type == 'monthly'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          GITHUB_ACTIONS: true
        run: |
          cd static/txc_processor
          echo "‚¨áÔ∏è  Downloading monthly bulk archive..."
          python3 download_txc.py
          echo ""
          echo "‚öôÔ∏è  Processing schedules (TRUNCATE + full reload)..."
          python3 create_schedule_efficient.py
          echo ""
          echo "‚úÖ Monthly processing complete!"
      
      - name: Notify VM - Monthly Success
        if: steps.update-type.outputs.type == 'monthly' && success()
        env:
          VM_HOST: ${{ secrets.DB_HOST }}
        run: |
          echo "üì° Notifying VM of successful completion..."
          curl -X POST http://$VM_HOST:8765/ \
            -H "Content-Type: application/json" \
            -d '{"type":"monthly","status":"success"}' \
            --max-time 5 || echo "Warning: Could not notify VM (non-critical)"
      
      - name: Notify VM - Monthly Failed
        if: steps.update-type.outputs.type == 'monthly' && failure()
        env:
          VM_HOST: ${{ secrets.DB_HOST }}
        run: |
          echo "üì° Notifying VM of failure..."
          curl -X POST http://$VM_HOST:8765/ \
            -H "Content-Type: application/json" \
            -d '{"type":"monthly","status":"failed"}' \
            --max-time 5 || echo "Warning: Could not notify VM (non-critical)"
      
      - name: Process Daily Update
        if: steps.update-type.outputs.type == 'daily'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          UPDATE_DATE: ${{ github.event.client_payload.date }}
          GITHUB_ACTIONS: true
        run: |
          cd static/txc_processor
          echo "‚¨áÔ∏è  Downloading daily update for $UPDATE_DATE..."
          python3 download_daily.py
          echo ""
          echo "‚öôÔ∏è  Processing daily changes (incremental UPDATE)..."
          python3 process_daily_incremental.py
          echo ""
          echo "‚úÖ Daily processing complete!"
      
      - name: Notify VM - Daily Success
        if: steps.update-type.outputs.type == 'daily' && success()
        env:
          VM_HOST: ${{ secrets.DB_HOST }}
        run: |
          echo "üì° Notifying VM of successful completion..."
          curl -X POST http://$VM_HOST:8765/ \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","status":"success"}' \
            --max-time 5 || echo "Warning: Could not notify VM (non-critical)"
      
      - name: Notify VM - Daily Failed
        if: steps.update-type.outputs.type == 'daily' && failure()
        env:
          VM_HOST: ${{ secrets.DB_HOST }}
        run: |
          echo "üì° Notifying VM of failure..."
          curl -X POST http://$VM_HOST:8765/ \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","status":"failed"}' \
            --max-time 5 || echo "Warning: Could not notify VM (non-critical)"
      
      - name: Cleanup temporary files
        if: always()
        run: |
          echo "üóëÔ∏è  Cleaning up temporary files..."
          rm -rf /tmp/txc_monthly /tmp/txc_daily /tmp/requirements.txt
          echo "‚úÖ Cleanup complete"
      
      - name: Upload logs (if present)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs-${{ github.run_number }}
          path: |
            static/txc_processor/*.log
          retention-days: 7
          if-no-files-found: ignore
